<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>Assessing variable importance in survival analysis using machine learning • survML</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><link href="../deps/font-awesome-6.4.2/css/all.min.css" rel="stylesheet">
<link href="../deps/font-awesome-6.4.2/css/v4-shims.min.css" rel="stylesheet">
<script src="../deps/headroom-0.11.0/headroom.min.js"></script><script src="../deps/headroom-0.11.0/jQuery.headroom.min.js"></script><script src="../deps/bootstrap-toc-1.0.1/bootstrap-toc.min.js"></script><script src="../deps/clipboard.js-2.0.11/clipboard.min.js"></script><script src="../deps/search-1.0.0/autocomplete.jquery.min.js"></script><script src="../deps/search-1.0.0/fuse.min.js"></script><script src="../deps/search-1.0.0/mark.min.js"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Assessing variable importance in survival analysis using machine learning">
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>


    <nav class="navbar navbar-expand-lg fixed-top bg-light" data-bs-theme="light" aria-label="Site navigation"><div class="container">

    <a class="navbar-brand me-2" href="../index.html">survML</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.1.0.9000</small>


    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item"><a class="nav-link" href="../reference/index.html">Reference</a></li>
<li class="active nav-item dropdown">
  <button class="nav-link dropdown-toggle" type="button" id="dropdown-articles" data-bs-toggle="dropdown" aria-expanded="false" aria-haspopup="true">Articles</button>
  <ul class="dropdown-menu" aria-labelledby="dropdown-articles">
<li><a class="dropdown-item" href="../articles/conditional_survival.html">Estimating a conditional survival function using off-the-shelf machine learning tools</a></li>
    <li><a class="dropdown-item" href="../articles/variable-importance.html">Assessing variable importance in survival analysis using machine learning</a></li>
  </ul>
</li>
<li class="nav-item"><a class="nav-link" href="../news/index.html">Changelog</a></li>
      </ul>
<ul class="navbar-nav">
<li class="nav-item"><form class="form-inline" role="search">
 <input class="form-control" type="search" name="search-input" id="search-input" autocomplete="off" aria-label="Search site" placeholder="Search for" data-search-index="../search.json">
</form></li>
<li class="nav-item"><a class="external-link nav-link" href="https://github.com/cwolock/survML/" aria-label="GitHub"><span class="fa fab fa-github fa-lg"></span></a></li>
      </ul>
</div>


  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">

      <h1>Assessing variable importance in survival analysis using machine learning</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/cwolock/survML/blob/main/vignettes/variable-importance.Rmd" class="external-link"><code>vignettes/variable-importance.Rmd</code></a></small>
      <div class="d-none name"><code>variable-importance.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/cwolock/survML" class="external-link">survML</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; Loading required package: SuperLearner</span></span>
<span><span class="co">#&gt; Loading required package: nnls</span></span>
<span><span class="co">#&gt; Loading required package: gam</span></span>
<span><span class="co">#&gt; Loading required package: splines</span></span>
<span><span class="co">#&gt; Loading required package: foreach</span></span>
<span><span class="co">#&gt; Loaded gam 1.22-4</span></span>
<span><span class="co">#&gt; Super Learner</span></span>
<span><span class="co">#&gt; Version: 2.0-29</span></span>
<span><span class="co">#&gt; Package created on 2024-02-06</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/therneau/survival" class="external-link">survival</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org" class="external-link">dplyr</a></span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Attaching package: 'dplyr'</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:stats':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     filter, lag</span></span>
<span><span class="co">#&gt; The following objects are masked from 'package:base':</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt;     intersect, setdiff, setequal, union</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">72924</span><span class="op">)</span></span></code></pre></div>
<div class="section level2">
<h2 id="introduction">Introduction<a class="anchor" aria-label="anchor" href="#introduction"></a>
</h2>
<p>The <code>survML</code> package includes functions that can be used
to estimate model-free, algorithm-agnostic variable importance when the
outcome of interest is subject to right censoring. Specifically, this
functionality is aimed at estimating <em>intrinsic</em> variable
importance, which is the population-level predictiveness potential of a
feature or group of features.</p>
<p>Suppose we have access to a vector
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
of features, which we wish to use to make a prediction involving
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>,
a time-to-event outcome. We use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
to denote the right censoring variable. The observed data are given by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="true" form="prefix">(</mo><mi>X</mi><mo>,</mo><mi>Y</mi><mo>,</mo><mi>Δ</mi><mo stretchy="true" form="postfix">)</mo></mrow><annotation encoding="application/x-tex">(X, Y, \Delta)</annotation></semantics></math>,
where
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Δ</mi><mo>:=</mo><mi>I</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo>≤</mo><mi>C</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">\Delta := I(T \leq C)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>Y</mi><mo>:=</mo><mtext mathvariant="normal">min</mtext><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo>,</mo><mi>C</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">Y := \text{min}(T, C)</annotation></semantics></math>.
For an index set
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>,
we use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>s</mi></msub><annotation encoding="application/x-tex">X_s</annotation></semantics></math>
to denote the elements of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>
with index in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mrow><mo>−</mo><mi>s</mi></mrow></msub><annotation encoding="application/x-tex">X_{-s}</annotation></semantics></math>
its complement. For a given prediction task (say, estimating the
probability that
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
is smaller than some landmark time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>)
and prediction function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>f</mi><annotation encoding="application/x-tex">f</annotation></semantics></math>,
we require a measure of predictiveness. We let
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mrow><mo stretchy="true" form="prefix">(</mo><mi>f</mi><mo>,</mo><msub><mi>P</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">V(f, P_0)</annotation></semantics></math>
denote the predictiveness of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>f</mi><annotation encoding="application/x-tex">f</annotation></semantics></math>
under sampling from distribution
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>P</mi><mn>0</mn></msub><annotation encoding="application/x-tex">P_0</annotation></semantics></math>.
We define
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mi>s</mi></mrow></msub><annotation encoding="application/x-tex">f_{0,s}</annotation></semantics></math>
as the <em>oracle prediction function</em> excluding features with index
in
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>;
this is the best possible prediction function, according to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>V</mi><annotation encoding="application/x-tex">V</annotation></semantics></math>,
that uses only
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mrow><mo>−</mo><mi>s</mi></mrow></msub><annotation encoding="application/x-tex">X_{-s}</annotation></semantics></math>.</p>
<p>For intrinsic variable importance, we consider nested index sets
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>r</mi><mo>⊂</mo><mi>s</mi></mrow><annotation encoding="application/x-tex">r \subset s</annotation></semantics></math>
and define the importance of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mrow><mi>s</mi><mo>\</mo><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">X_{s \setminus r}</annotation></semantics></math>
relative to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>s</mi></msub><annotation encoding="application/x-tex">X_s</annotation></semantics></math>
as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mi>r</mi></mrow></msub><mo>,</mo><msub><mi>P</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mi>V</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mi>s</mi></mrow></msub><mo>,</mo><msub><mi>P</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">V(f_{0,r}, P_0) - V(f_{0,s}, P_0)</annotation></semantics></math>;
this is the difference in maximum achievable predictiveness when only
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
is excluded compared to when
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>
is excluded. We refer to this parameter as a variable importance measure
(VIM).</p>
<p>Due to right censoring, the VIM estimation procedure requires
estimates of the conditional survival functions of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
given
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>X</mi><annotation encoding="application/x-tex">X</annotation></semantics></math>,
which we define pointwise as
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>∣</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>:=</mo><msub><mi>P</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>T</mi><mo>&gt;</mo><mi>t</mi><mo>∣</mo><mi>X</mi><mo>=</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S_0(t \mid x) := P_0(T &gt; t \mid X = x)</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>G</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>t</mi><mo>∣</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow><mo>:=</mo><msub><mi>P</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>C</mi><mo>&gt;</mo><mi>t</mi><mo>∣</mo><mi>X</mi><mo>=</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">G_0(t \mid x) := P_0(C &gt; t \mid X = x)</annotation></semantics></math>,
respectively. These functions must be estimated over the interval
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mo stretchy="false" form="prefix">(</mo><mn>0</mn><mo>,</mo><mi>τ</mi><mo stretchy="false" form="postfix">]</mo></mrow><annotation encoding="application/x-tex">(0, \tau]</annotation></semantics></math>
and may be obtained from any conditional survival estimation algorithm.
This may be as simple as a Cox proportional hazards model (Cox, 1972) or
parametric survival regression model, or as complex as a stacked
regression procedure such as survival Super Learner (Westling et al.,
2023) or global survival stacking (Wolock et al., 2024).</p>
<p>We also require estimates of the oracle prediction functions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">f_{0,r}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mi>s</mi></mrow></msub><annotation encoding="application/x-tex">f_{0,s}</annotation></semantics></math>,
whose exact form depends on the chosen predictiveness measure. For
several commonly used measures, the oracle prediction functions can be
written in terms of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mo>⋅</mo><mo>∣</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S_0(\cdot \mid x)</annotation></semantics></math>.
The form of the oracle prediction function for the measures included in
<code>survML</code> is given in the Appendix.</p>
</div>
<div class="section level2">
<h2 id="example-predicting-recurrence-free-survival-time-in-cancer-patients">Example: Predicting recurrence-free survival time in cancer
patients<a class="anchor" aria-label="anchor" href="#example-predicting-recurrence-free-survival-time-in-cancer-patients"></a>
</h2>
<p>As an example, we consider estimating variable importance for
predicting recurrence-free survival using the <code>gbsg</code> dataset
in the <code>survival</code> package. The Kaplan-Meier estimate of the
survival curve for this dataset is shown below.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/data.html" class="external-link">data</a></span><span class="op">(</span><span class="va">cancer</span><span class="op">)</span></span>
<span><span class="va">km_fit</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/survival/man/survfit.html" class="external-link">survfit</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/survival/man/Surv.html" class="external-link">Surv</a></span><span class="op">(</span><span class="va">rfstime</span>, <span class="va">status</span><span class="op">)</span> <span class="op">~</span> <span class="fl">1</span>, data <span class="op">=</span> <span class="va">gbsg</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">km_fit</span>, xlab <span class="op">=</span> <span class="st">"Time (days)"</span>, ylab <span class="op">=</span> <span class="st">"Recurrence-free survival probability"</span><span class="op">)</span></span></code></pre></div>
<p><img src="variable-importance_files/figure-html/km-1.png" width="768"></p>
<p>We will consider time-varying AUC importance using landmark times of
500, 1000, 1500 and 2000 days. The first step is to prepare the data. We
use dummy coding for factors. This means that to assess the importance
of tumor grade, for example, which has three levels, we create two dummy
variables called <code>tumgrad2</code> and <code>tumgrad3</code> and
consider them as a single feature group. We also consider the feature
groups defined by tumor-level features and patient-level features.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">### variables of interest</span></span>
<span><span class="co"># rfstime - recurrence-free survival</span></span>
<span><span class="co"># status - censoring indicator</span></span>
<span><span class="co"># hormon - hormonal therapy treatment indicator</span></span>
<span><span class="co"># age - in years</span></span>
<span><span class="co"># meno - 1 = premenopause, 2 = post</span></span>
<span><span class="co"># size - tumor size in mm</span></span>
<span><span class="co"># grade - factor 1,2,3</span></span>
<span><span class="co"># nodes - number of positive nodes</span></span>
<span><span class="co"># pgr - progesterone receptor in fmol</span></span>
<span><span class="co"># er - estrogen receptor in fmol</span></span>
<span></span>
<span><span class="co"># create dummy variables and clean data</span></span>
<span><span class="va">gbsg</span><span class="op">$</span><span class="va">tumgrad2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">gbsg</span><span class="op">$</span><span class="va">grade</span> <span class="op">==</span> <span class="fl">2</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">gbsg</span><span class="op">$</span><span class="va">tumgrad3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">gbsg</span><span class="op">$</span><span class="va">grade</span> <span class="op">==</span> <span class="fl">3</span>, <span class="fl">1</span>, <span class="fl">0</span><span class="op">)</span></span>
<span><span class="va">gbsg</span> <span class="op">&lt;-</span> <span class="va">gbsg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html" class="external-link">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pid</span>, <span class="va">grade</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="va">time</span> <span class="op">&lt;-</span> <span class="va">gbsg</span><span class="op">$</span><span class="va">rfstime</span></span>
<span><span class="va">event</span> <span class="op">&lt;-</span> <span class="va">gbsg</span><span class="op">$</span><span class="va">status</span></span>
<span><span class="va">X</span> <span class="op">&lt;-</span> <span class="va">gbsg</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html" class="external-link">select</a></span><span class="op">(</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">rfstime</span>, <span class="va">status</span><span class="op">)</span><span class="op">)</span> <span class="co"># remove outcome </span></span>
<span></span>
<span><span class="co"># find column indices of features/feature groups</span></span>
<span><span class="va">X_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/names.html" class="external-link">names</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span><span class="va">age_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"age"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">meno_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"meno"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">size_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"size"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nodes_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"nodes"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pgr_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"pgr"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">er_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"er"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hormon_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"hormon"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">grade_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tumgrad2"</span>, <span class="st">"tumgrad3"</span><span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">tum_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"size"</span>, <span class="st">"nodes"</span>, <span class="st">"pgr"</span>, <span class="st">"er"</span>, <span class="st">"tumgrad2"</span>, <span class="st">"tumgrad3"</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">person_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"meno"</span>, <span class="st">"hormon"</span><span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature_group_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"meno."</span>, <span class="st">"size"</span>, <span class="st">"nodes"</span>,</span>
<span>                         <span class="st">"prog."</span>, <span class="st">"estro."</span>, <span class="st">"hormone"</span>, </span>
<span>                         <span class="st">"grade"</span><span class="op">)</span></span>
<span><span class="va">feature_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">age_index</span>, <span class="va">meno_index</span>, <span class="va">size_index</span>, <span class="va">nodes_index</span>,</span>
<span>                    <span class="va">pgr_index</span>, <span class="va">er_index</span>, <span class="va">hormon_index</span>, <span class="va">grade_index</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># consider joint importance of all tumor-level and person-level features</span></span>
<span><span class="va">feature_group_names2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tumor"</span>, <span class="st">"person"</span><span class="op">)</span></span>
<span><span class="va">feature_groups2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">tum_index</span>, <span class="va">person_index</span><span class="op">)</span></span></code></pre></div>
<p>Next, we write some functions to estimate all the relevant nuisance
parameters.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># estimate conditional survival functions</span></span>
<span><span class="va">generate_full_predictions</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>, </span>
<span>                                      <span class="va">event</span>, </span>
<span>                                      <span class="va">X</span>, </span>
<span>                                      <span class="va">X_holdout</span>, </span>
<span>                                      <span class="va">landmark_times</span>, </span>
<span>                                      <span class="va">approx_times</span>,</span>
<span>                                      <span class="va">SL.library</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>    <span class="va">surv_out</span> <span class="op">&lt;-</span> <span class="fu">survML</span><span class="fu">::</span><span class="fu"><a href="../reference/stackG.html">stackG</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                               event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                               X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                               newX <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">X_holdout</span>, <span class="va">X</span><span class="op">)</span>,</span>
<span>                               newtimes <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>                               time_grid_approx <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>                               bin_size <span class="op">=</span> <span class="fl">0.05</span>,</span>
<span>                               time_basis <span class="op">=</span> <span class="st">"continuous"</span>,</span>
<span>                               surv_form <span class="op">=</span> <span class="st">"PI"</span>,</span>
<span>                               SL_control <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>SL.library <span class="op">=</span> <span class="va">SL.library</span>,</span>
<span>                                                 V <span class="op">=</span> <span class="fl">5</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="va">S_hat</span> <span class="op">&lt;-</span> <span class="va">surv_out</span><span class="op">$</span><span class="va">S_T_preds</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_holdout</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">G_hat</span> <span class="op">&lt;-</span> <span class="va">surv_out</span><span class="op">$</span><span class="va">S_C_preds</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_holdout</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">f_hat</span> <span class="op">&lt;-</span> <span class="va">S_hat</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">approx_times</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">landmark_times</span><span class="op">)</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span>
<span>    <span class="va">S_hat_train</span> <span class="op">&lt;-</span> <span class="va">surv_out</span><span class="op">$</span><span class="va">S_T_preds</span><span class="op">[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_holdout</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_holdout</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">G_hat_train</span> <span class="op">&lt;-</span> <span class="va">surv_out</span><span class="op">$</span><span class="va">S_C_preds</span><span class="op">[</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_holdout</span><span class="op">)</span><span class="op">+</span><span class="fl">1</span><span class="op">)</span><span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_holdout</span><span class="op">)</span><span class="op">+</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span><span class="op">)</span>,<span class="op">]</span></span>
<span>    <span class="va">f_hat_train</span> <span class="op">&lt;-</span> <span class="va">S_hat_train</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">approx_times</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">landmark_times</span><span class="op">)</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>S_hat <span class="op">=</span> <span class="va">S_hat</span>,</span>
<span>              G_hat <span class="op">=</span> <span class="va">G_hat</span>,</span>
<span>              f_hat <span class="op">=</span> <span class="va">f_hat</span>,</span>
<span>              f_hat_train <span class="op">=</span> <span class="va">f_hat_train</span>,</span>
<span>              S_hat_train <span class="op">=</span> <span class="va">S_hat_train</span>,</span>
<span>              G_hat_train <span class="op">=</span> <span class="va">G_hat_train</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># estimate residual oracle prediction function by regressing full predictions on reduced feature vector</span></span>
<span><span class="va">generate_reduced_predictions</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">f_hat</span>,</span>
<span>                                         <span class="va">X_reduced</span>,</span>
<span>                                         <span class="va">X_reduced_holdout</span>,</span>
<span>                                         <span class="va">landmark_times</span>,</span>
<span>                                         <span class="va">SL.library</span><span class="op">)</span><span class="op">{</span></span>
<span>  </span>
<span>  <span class="va">long_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>f_hat <span class="op">=</span> <span class="va">f_hat</span>, <span class="va">X_reduced</span><span class="op">)</span></span>
<span>  <span class="va">long_new_dat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span><span class="va">X_reduced_holdout</span><span class="op">)</span></span>
<span>  <span class="va">reduced_fit</span> <span class="op">&lt;-</span> <span class="fu">SuperLearner</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SuperLearner/man/SuperLearner.html" class="external-link">SuperLearner</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">long_dat</span><span class="op">$</span><span class="va">f_hat</span>,</span>
<span>                                            X <span class="op">=</span> <span class="va">long_dat</span><span class="op">[</span>,<span class="fl">2</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">long_dat</span><span class="op">)</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span>,</span>
<span>                                            family <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                            SL.library <span class="op">=</span> <span class="va">SL.library</span>,</span>
<span>                                            method <span class="op">=</span> <span class="st">"method.NNLS"</span>,</span>
<span>                                            verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>  <span class="va">fs_hat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">reduced_fit</span>, newdata <span class="op">=</span> <span class="va">long_new_dat</span><span class="op">)</span><span class="op">$</span><span class="va">pred</span>,</span>
<span>                   nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_reduced_holdout</span><span class="op">)</span>,</span>
<span>                   ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">landmark_times</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>fs_hat <span class="op">=</span> <span class="va">fs_hat</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># produce cross-fitted full predictions</span></span>
<span><span class="va">CV_generate_full_predictions</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>,</span>
<span>                                         <span class="va">event</span>,</span>
<span>                                         <span class="va">X</span>,</span>
<span>                                         <span class="va">landmark_times</span>,</span>
<span>                                         <span class="va">approx_times</span>,</span>
<span>                                         <span class="va">folds</span>,</span>
<span>                                         <span class="va">sample_split</span>,</span>
<span>                                         <span class="va">SL.library</span>,</span>
<span>                                         <span class="va">DR_pred</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">.V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">folds</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">CV_full_preds_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">CV_full_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">CV_S_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">CV_S_preds_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  <span class="va">CV_G_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">.V</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">time_train</span> <span class="op">&lt;-</span> <span class="va">time</span><span class="op">[</span><span class="va">folds</span> <span class="op">!=</span> <span class="va">j</span><span class="op">]</span></span>
<span>    <span class="va">event_train</span> <span class="op">&lt;-</span> <span class="va">event</span><span class="op">[</span><span class="va">folds</span> <span class="op">!=</span> <span class="va">j</span><span class="op">]</span></span>
<span>    <span class="va">X_train</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">folds</span> <span class="op">!=</span> <span class="va">j</span>,<span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">X_holdout</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">folds</span> <span class="op">==</span> <span class="va">j</span>,<span class="op">]</span></span>
<span>    <span class="va">full_preds</span> <span class="op">&lt;-</span> <span class="fu">generate_full_predictions</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time_train</span>,</span>
<span>                                            event <span class="op">=</span> <span class="va">event_train</span>,</span>
<span>                                            X <span class="op">=</span> <span class="va">X_train</span>,</span>
<span>                                            X_holdout <span class="op">=</span> <span class="va">X_holdout</span>,</span>
<span>                                            landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                                            approx_times <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>                                            SL.library <span class="op">=</span> <span class="va">SL.library</span><span class="op">)</span></span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="va">DR_pred</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">CV_full_preds_train</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">full_preds</span><span class="op">$</span><span class="va">f_hat_train</span></span>
<span>        <span class="va">CV_full_preds</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">full_preds</span><span class="op">$</span><span class="va">f_hat</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span><span class="op">{</span> <span class="co"># doubly-robust version --- see below</span></span>
<span>        <span class="va">DR_preds</span> <span class="op">&lt;-</span> <span class="fu">generate_DR_predictions</span><span class="op">(</span></span>
<span>          time <span class="op">=</span> <span class="va">time_train</span>,</span>
<span>          event <span class="op">=</span> <span class="va">event_train</span>,</span>
<span>          X <span class="op">=</span> <span class="va">X_train</span>,</span>
<span>          X_holdout <span class="op">=</span> <span class="va">X_holdout</span>,</span>
<span>          landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>          approx_times <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>          S_hat <span class="op">=</span> <span class="va">full_preds</span><span class="op">$</span><span class="va">S_hat_train</span>,</span>
<span>          G_hat <span class="op">=</span> <span class="va">full_preds</span><span class="op">$</span><span class="va">G_hat_train</span>,</span>
<span>          SL.library <span class="op">=</span> <span class="va">SL.library</span></span>
<span>        <span class="op">)</span></span>
<span>        <span class="va">CV_full_preds_train</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">DR_preds</span><span class="op">$</span><span class="va">f_hat_train</span></span>
<span>        <span class="va">CV_full_preds</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">DR_preds</span><span class="op">$</span><span class="va">f_hat</span></span>
<span>      <span class="op">}</span></span>
<span>    <span class="va">CV_S_preds</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">full_preds</span><span class="op">$</span><span class="va">S_hat</span></span>
<span>    <span class="va">CV_G_preds</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">full_preds</span><span class="op">$</span><span class="va">G_hat</span></span>
<span>    <span class="va">CV_S_preds_train</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">full_preds</span><span class="op">$</span><span class="va">S_hat_train</span></span>
<span>  <span class="op">}</span></span>
<span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>CV_full_preds_train <span class="op">=</span> <span class="va">CV_full_preds_train</span>,</span>
<span>              CV_full_preds <span class="op">=</span> <span class="va">CV_full_preds</span>,</span>
<span>              CV_S_preds <span class="op">=</span> <span class="va">CV_S_preds</span>,</span>
<span>              CV_S_preds_train <span class="op">=</span> <span class="va">CV_S_preds_train</span>,</span>
<span>              CV_G_preds <span class="op">=</span> <span class="va">CV_G_preds</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># produce cross-fitted reduced predictions</span></span>
<span><span class="va">CV_generate_reduced_predictions</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>,</span>
<span>                                            <span class="va">event</span>,</span>
<span>                                            <span class="va">X</span>,</span>
<span>                                            <span class="va">landmark_times</span>,</span>
<span>                                            <span class="va">folds</span>,</span>
<span>                                            <span class="va">indx</span>,</span>
<span>                                            <span class="va">sample_split</span>,</span>
<span>                                            <span class="va">full_preds_train</span>,</span>
<span>                                            <span class="va">SL.library</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">.V</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="va">folds</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">CV_reduced_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">j</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="va">.V</span><span class="op">)</span><span class="op">{</span></span>
<span>    </span>
<span>    <span class="va">X_reduced_train</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">folds</span> <span class="op">!=</span> <span class="va">j</span>,<span class="op">-</span><span class="va">indx</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span>
<span>    <span class="va">X_reduced_holdout</span> <span class="op">&lt;-</span> <span class="va">X</span><span class="op">[</span><span class="va">folds</span> <span class="op">==</span> <span class="va">j</span>,<span class="op">-</span><span class="va">indx</span>,drop<span class="op">=</span><span class="cn">FALSE</span><span class="op">]</span></span>
<span>    </span>
<span>    <span class="va">preds_j</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_reduced_holdout</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">landmark_times</span><span class="op">)</span><span class="op">)</span></span>
<span>    <span class="kw">for</span> <span class="op">(</span><span class="va">t</span> <span class="kw">in</span> <span class="va">landmark_times</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="va">outcomes</span> <span class="op">&lt;-</span> <span class="va">full_preds_train</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">landmark_times</span> <span class="op">==</span> <span class="va">t</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="va">reduced_preds</span> <span class="op">&lt;-</span> <span class="fu">generate_reduced_predictions</span><span class="op">(</span>f_hat <span class="op">=</span> <span class="va">outcomes</span>,</span>
<span>                                                    X_reduced <span class="op">=</span> <span class="va">X_reduced_train</span>,</span>
<span>                                                    X_reduced_holdout <span class="op">=</span> <span class="va">X_reduced_holdout</span>,</span>
<span>                                                    landmark_times <span class="op">=</span> <span class="va">t</span>,</span>
<span>                                                    SL.library <span class="op">=</span> <span class="va">SL.library</span><span class="op">)</span></span>
<span>      </span>
<span>      <span class="va">preds_j</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">landmark_times</span> <span class="op">==</span> <span class="va">t</span><span class="op">)</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">reduced_preds</span><span class="op">$</span><span class="va">fs_hat</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span>    <span class="va">CV_reduced_preds</span><span class="op">[[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">preds_j</span></span>
<span>  <span class="op">}</span></span>
<span>  </span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">CV_reduced_preds</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<div class="section level3">
<h3 id="estimating-subtractive-variable-importance">Estimating subtractive variable importance<a class="anchor" aria-label="anchor" href="#estimating-subtractive-variable-importance"></a>
</h3>
<p>First, we consider the importance of each of the feature groups
relative to the full feature vector. We call this <em>subtractive</em>
variable importance — the features of interest are subtracted from the
full feature vector, with importance measured by the resulting loss in
predictiveness.</p>
<p>Note that because censoring may be informed by covariates that are
not part of the current reduced feature set, we estimate the residual
oracle prediction function by regressing the full oracle predictions on
the reduced feature set, rather than directly estimating the conditional
survival function using the reduced feature set.</p>
<p>To reduce runtime, we use a very small Super Learner library. In
actual analyses, it is generally a good idea to use a larger library of
learners.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># super learner library for global survival stacking</span></span>
<span><span class="va">SL.library</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"SL.mean"</span>, <span class="st">"SL.glm"</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># landmark times for AUC</span></span>
<span><span class="va">landmark_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">1500</span>, <span class="fl">2000</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># set up cross-fitting and sample-splitting folds</span></span>
<span><span class="va">cf_fold_num</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">ss_fold_num</span> <span class="op">&lt;-</span> <span class="fl">2</span><span class="op">*</span><span class="va">cf_fold_num</span></span>
<span><span class="va">V</span> <span class="op">&lt;-</span> <span class="va">ss_fold_num</span></span>
<span><span class="va">folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sample.html" class="external-link">sample</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="va">V</span><span class="op">)</span>, length <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">gbsg</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="co"># 2V of them</span></span>
<span><span class="va">ss_folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">V</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">2</span>, <span class="va">V</span><span class="op">/</span><span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">ss_folds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="va">folds</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">ss_folds</span> <span class="op">==</span> <span class="fl">2</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># approximation time grid for integrals </span></span>
<span><span class="va">approx_times</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html" class="external-link">sort</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html" class="external-link">unique</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">time</span><span class="op">[</span><span class="va">event</span> <span class="op">==</span> <span class="fl">1</span> <span class="op">&amp;</span> <span class="va">time</span> <span class="op">&lt;=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">max</a></span><span class="op">(</span><span class="va">landmark_times</span><span class="op">)</span><span class="op">]</span>, </span>
<span>                              <span class="va">landmark_times</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># generate nuisance estimates</span></span>
<span><span class="va">V0_preds</span> <span class="op">&lt;-</span> <span class="fu">CV_generate_full_predictions</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                                         event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                         X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                                         landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                                         approx_times <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>                                         folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                                         sample_split <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                         SL.library <span class="op">=</span> <span class="va">SL.library</span>,</span>
<span>                                         DR_pred <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">CV_full_preds</span> <span class="op">&lt;-</span> <span class="va">V0_preds</span><span class="op">$</span><span class="va">CV_full_preds</span></span>
<span><span class="va">CV_full_preds_train</span> <span class="op">&lt;-</span> <span class="va">V0_preds</span><span class="op">$</span><span class="va">CV_full_preds_train</span></span>
<span><span class="va">CV_S_preds</span> <span class="op">&lt;-</span> <span class="va">V0_preds</span><span class="op">$</span><span class="va">CV_S_preds</span></span>
<span><span class="va">CV_S_preds_train</span> <span class="op">&lt;-</span> <span class="va">V0_preds</span><span class="op">$</span><span class="va">CV_S_preds_train</span></span>
<span><span class="va">CV_G_preds</span> <span class="op">&lt;-</span> <span class="va">V0_preds</span><span class="op">$</span><span class="va">CV_G_preds</span></span>
<span></span>
<span><span class="co"># iterate over feature groups</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_group_names</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indx_char</span> <span class="op">&lt;-</span> <span class="va">feature_groups</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">indx_name</span> <span class="op">&lt;-</span> <span class="va">feature_group_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">indx_char</span>, split <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># estimate residual oracle prediction function for this feature group</span></span>
<span>  <span class="va">CV_reduced_preds</span> <span class="op">&lt;-</span> <span class="fu">CV_generate_reduced_predictions</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                                              event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                              X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                                              landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                                              folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                                              sample_split <span class="op">=</span> <span class="va">sample_split</span>,</span>
<span>                                              indx <span class="op">=</span> <span class="va">indx</span>,</span>
<span>                                              full_preds_train <span class="op">=</span> <span class="va">CV_full_preds_train</span>,</span>
<span>                                              SL.library <span class="op">=</span> <span class="va">SL.library</span><span class="op">)</span></span>
<span>  <span class="co"># estimate VIM - note the oracle for AUC is the conditional cdf, not survival function, </span></span>
<span>  <span class="co"># so need to take 1 - S(tau | x)</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vim_AUC.html">vim_AUC</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                    event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                    approx_times <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>                    landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                    f_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CV_full_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    fs_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CV_reduced_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    S_hat <span class="op">=</span> <span class="va">CV_S_preds</span>,</span>
<span>                    G_hat <span class="op">=</span> <span class="va">CV_G_preds</span>,</span>
<span>                    folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                    ss_folds <span class="op">=</span> <span class="va">ss_folds</span>,</span>
<span>                    sample_split <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    scale_est <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">vim</span> <span class="op">&lt;-</span> <span class="st">"AUC"</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">indx_char</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indx_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">indx_name</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">pooled_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pooled_output</span>, <span class="va">output</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">pooled_output</span> <span class="op">&lt;-</span> <span class="va">output</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># plot results</span></span>
<span><span class="va">p_auc</span> <span class="op">&lt;-</span> <span class="va">pooled_output</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>landmark_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">landmark_time</span>,</span>
<span>                                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">1500</span>, <span class="fl">2000</span><span class="op">)</span>,</span>
<span>                                labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"500 days"</span>, <span class="st">"1000 days"</span>, <span class="st">"1500 days"</span>, <span class="st">"2000 days"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">landmark_time</span>, <span class="va">est</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Order <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="op">{</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">est</span>, y <span class="op">=</span> <span class="va">Order</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_errorbarh.html" class="external-link">geom_errorbarh</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">cil</span>, xmax <span class="op">=</span> <span class="va">ciu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated importance"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Feature group"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>        breaks <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">Order</span>,</span>
<span>        labels <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">indx_name</span>,</span>
<span>      <span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">landmark_time</span>, dir <span class="op">=</span> <span class="st">"v"</span>, strip.position <span class="op">=</span> <span class="st">"right"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Subtractive AUC variable importance"</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            strip.placement <span class="op">=</span> <span class="st">"outside"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">p_auc</span></span></code></pre></div>
<p><img src="variable-importance_files/figure-html/unnamed-chunk-3-1.png" width="768"></p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># repeat the analysis for feature groups</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_group_names2</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indx_char</span> <span class="op">&lt;-</span> <span class="va">feature_groups2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">indx_name</span> <span class="op">&lt;-</span> <span class="va">feature_group_names2</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">indx_char</span>, split <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">CV_reduced_preds</span> <span class="op">&lt;-</span> <span class="fu">CV_generate_reduced_predictions</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                                              event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                              X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                                              landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                                              folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                                              sample_split <span class="op">=</span> <span class="va">sample_split</span>,</span>
<span>                                              indx <span class="op">=</span> <span class="va">indx</span>,</span>
<span>                                              full_preds_train <span class="op">=</span> <span class="va">CV_full_preds_train</span>,</span>
<span>                                              SL.library <span class="op">=</span> <span class="va">SL.library</span><span class="op">)</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vim_AUC.html">vim_AUC</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                    event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                    approx_times <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>                    landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                    f_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CV_full_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    fs_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CV_reduced_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    S_hat <span class="op">=</span> <span class="va">CV_S_preds</span>,</span>
<span>                    G_hat <span class="op">=</span> <span class="va">CV_G_preds</span>,</span>
<span>                    folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                    ss_folds <span class="op">=</span> <span class="va">ss_folds</span>,</span>
<span>                    sample_split <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    scale_est <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">vim</span> <span class="op">&lt;-</span> <span class="st">"AUC"</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">indx_char</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indx_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">indx_name</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">pooled_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pooled_output</span>, <span class="va">output</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">pooled_output</span> <span class="op">&lt;-</span> <span class="va">output</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">p_auc</span> <span class="op">&lt;-</span> <span class="va">pooled_output</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>landmark_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">landmark_time</span>,</span>
<span>                                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">1500</span>, <span class="fl">2000</span><span class="op">)</span>,</span>
<span>                                labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"500 days"</span>, <span class="st">"1000 days"</span>, <span class="st">"1500 days"</span>, <span class="st">"2000 days"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">landmark_time</span>, <span class="va">est</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Order <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="op">{</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">est</span>, y <span class="op">=</span> <span class="va">Order</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_errorbarh.html" class="external-link">geom_errorbarh</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">cil</span>, xmax <span class="op">=</span> <span class="va">ciu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated importance"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Feature group"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.5</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>        breaks <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">Order</span>,</span>
<span>        labels <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">indx_name</span>,</span>
<span>      <span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">landmark_time</span>, dir <span class="op">=</span> <span class="st">"v"</span>, strip.position <span class="op">=</span> <span class="st">"right"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Subtractive AUC variable importance (groups)"</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            strip.placement <span class="op">=</span> <span class="st">"outside"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">p_auc</span></span></code></pre></div>
<p><img src="variable-importance_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
</div>
<div class="section level3">
<h3 id="estimating-additive-variable-importance">Estimating additive variable importance<a class="anchor" aria-label="anchor" href="#estimating-additive-variable-importance"></a>
</h3>
<p>Next, we consider the importance of each of the tumor-level features
relative to a <em>baseline</em> set of person-level features. We call
this <em>additive</em> variable importance — the feature of interest is
added to a baseline set of features, with importance measured by the
resulting gain in predictiveness.</p>
<p>For this analysis, the “full” oracle predictions include baseline
features plus the feature of interest, and the “residual” oracle
predictions include only baseline features. Note that both the full and
residual oracle prediction functions for this analysis are estimated by
regressing the conditional survival function estimates given
<strong>all</strong> features on the relevant reduced feature set. As in
the subtractive analysis, this step is necessary to account for
censoring that may be informed by covariates, even those which are not
included in the current set of predictors.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># For additive importance, the "reduced" model uses only person-level (baseline) features</span></span>
<span><span class="co"># The "full" model uses baseline + feature of interest</span></span>
<span><span class="co"># We wrote generate_reduced_predictions() to leave out the "indx" argument. Need to keep that in mind!</span></span>
<span><span class="va">size_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size_index</span>, <span class="va">person_index</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">nodes_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nodes_index</span>, <span class="va">person_index</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">pgr_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pgr_index</span>, <span class="va">person_index</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">er_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">er_index</span>, <span class="va">person_index</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">grade_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">grade_index</span>, <span class="va">person_index</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature_group_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"size"</span>, <span class="st">"nodes"</span>, <span class="st">"prog."</span>, <span class="st">"estro."</span>, <span class="st">"grade"</span><span class="op">)</span></span>
<span><span class="va">feature_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size_index</span>, <span class="va">nodes_index</span>,</span>
<span>                    <span class="va">pgr_index</span>, <span class="va">er_index</span>, <span class="va">grade_index</span><span class="op">)</span></span>
<span></span>
<span><span class="va">CV_reduced_preds</span> <span class="op">&lt;-</span> <span class="fu">CV_generate_reduced_predictions</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                                                    event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                                    X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                                                    landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                                                    folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                                                    sample_split <span class="op">=</span> <span class="va">sample_split</span>,</span>
<span>                                                    indx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">tum_index</span>, split <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                                                    full_preds_train <span class="op">=</span> <span class="va">CV_full_preds_train</span>,</span>
<span>                                                    SL.library <span class="op">=</span> <span class="va">SL.library</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_group_names</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indx_char</span> <span class="op">&lt;-</span> <span class="va">feature_groups</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">indx_name</span> <span class="op">&lt;-</span> <span class="va">feature_group_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">indx_char</span>, split <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">all_indx</span> <span class="op">&lt;-</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span></span>
<span>  <span class="co"># leave out features *not* in indx for additive importance</span></span>
<span>  <span class="va">indx</span> <span class="op">&lt;-</span> <span class="va">all_indx</span><span class="op">[</span><span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">all_indx</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">indx</span><span class="op">)</span><span class="op">]</span></span>
<span>  </span>
<span>  <span class="va">CV_full_preds</span> <span class="op">&lt;-</span> <span class="fu">CV_generate_reduced_predictions</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                                                   event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                                   X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                                                   landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                                                   folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                                                   sample_split <span class="op">=</span> <span class="va">sample_split</span>,</span>
<span>                                                   indx <span class="op">=</span> <span class="va">indx</span>,</span>
<span>                                                   full_preds_train <span class="op">=</span> <span class="va">CV_full_preds_train</span>,</span>
<span>                                                   SL.library <span class="op">=</span> <span class="va">SL.library</span><span class="op">)</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vim_AUC.html">vim_AUC</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                    event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                    approx_times <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>                    landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                    f_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CV_full_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    fs_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CV_reduced_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    S_hat <span class="op">=</span> <span class="va">CV_S_preds</span>,</span>
<span>                    G_hat <span class="op">=</span> <span class="va">CV_G_preds</span>,</span>
<span>                    folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                    ss_folds <span class="op">=</span> <span class="va">ss_folds</span>,</span>
<span>                    sample_split <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    scale_est <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">vim</span> <span class="op">&lt;-</span> <span class="st">"AUC"</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">indx_char</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indx_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">indx_name</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">pooled_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pooled_output</span>, <span class="va">output</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">pooled_output</span> <span class="op">&lt;-</span> <span class="va">output</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">p_auc</span> <span class="op">&lt;-</span> <span class="va">pooled_output</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>landmark_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">landmark_time</span>,</span>
<span>                                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">1500</span>, <span class="fl">2000</span><span class="op">)</span>,</span>
<span>                                labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"500 days"</span>, <span class="st">"1000 days"</span>, <span class="st">"1500 days"</span>, <span class="st">"2000 days"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">landmark_time</span>, <span class="va">est</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Order <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="op">{</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">est</span>, y <span class="op">=</span> <span class="va">Order</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_errorbarh.html" class="external-link">geom_errorbarh</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">cil</span>, xmax <span class="op">=</span> <span class="va">ciu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated importance"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Feature group"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>        breaks <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">Order</span>,</span>
<span>        labels <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">indx_name</span>,</span>
<span>      <span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">landmark_time</span>, dir <span class="op">=</span> <span class="st">"v"</span>, strip.position <span class="op">=</span> <span class="st">"right"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Additive AUC variable importance"</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            strip.placement <span class="op">=</span> <span class="st">"outside"</span><span class="op">)</span><span class="co">#,</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">p_auc</span></span></code></pre></div>
<p><img src="variable-importance_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
</div>
</div>
<div class="section level2">
<h2 id="adjustment-variables">Adjustment variables<a class="anchor" aria-label="anchor" href="#adjustment-variables"></a>
</h2>
<p>There may be covariates that are thought to influence both
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>T</mi><annotation encoding="application/x-tex">T</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>C</mi><annotation encoding="application/x-tex">C</annotation></semantics></math>
but are not of scientific interest in terms of variable importance. (We
may think of these covariates as analogous to confounders in a causal
inference setting.) It is important to adjust for these variables in all
analyses. In the <code>gbsg</code> analysis, for example, we may wish to
adjust for person-level covariates age, menopausal status, and hormone
treatment therapy, but to assess variable importance using only the
predictiveness of tumor-level covariates.</p>
<p>We use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>r</mi><annotation encoding="application/x-tex">r</annotation></semantics></math>
to denote the index set of adjustment variables, and again use
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>s</mi><annotation encoding="application/x-tex">s</annotation></semantics></math>
to denote the index set of variables of interest. The importance of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mi>s</mi></msub><annotation encoding="application/x-tex">X_s</annotation></semantics></math>
relative to
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>X</mi><mrow><mo>−</mo><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">X_{-r}</annotation></semantics></math>
(i.e., the full covariate vector excluding adjustment variables) is
given by
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>V</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mi>r</mi></mrow></msub><mo>,</mo><msub><mi>P</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow><mo>−</mo><mi>V</mi><mrow><mo stretchy="true" form="prefix">(</mo><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>r</mi><mo>∪</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msub><mo>,</mo><msub><mi>P</mi><mn>0</mn></msub><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">V(f_{0, r}, P_0) - V(f_{0, (r \cup s)}, P_0)</annotation></semantics></math>.</p>
<p>As usual, there are many possible approaches to estimating
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">f_{0,r}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>r</mi><mo>∪</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msub><annotation encoding="application/x-tex">f_{0,(r \cup s)}</annotation></semantics></math>,
depending on their explicit form. In the case of AUC predictiveness, we
can simply estimate the prediction models
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mi>r</mi></mrow></msub><annotation encoding="application/x-tex">f_{0,r}</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mrow><mo stretchy="true" form="prefix">(</mo><mi>r</mi><mo>∪</mo><mi>s</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow></msub><annotation encoding="application/x-tex">f_{0,(r \cup s)}</annotation></semantics></math>
by (1) estimating the full oracle prediction function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mn>0</mn></msub><annotation encoding="application/x-tex">f_0</annotation></semantics></math>,
(2) generating predictions for individuals in the training data, and
then (3) regressing those predictions on the appropriate reduced
covariate vector.</p>
<p>Here, we repeat the subtractive variable importance analysis
adjusting for person-level covariates.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">size_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size_index</span>, <span class="va">person_index</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">nodes_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">nodes_index</span>, <span class="va">person_index</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">pgr_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">pgr_index</span>, <span class="va">person_index</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">er_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">er_index</span>, <span class="va">person_index</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span><span class="va">grade_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">grade_index</span>, <span class="va">person_index</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature_group_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"size"</span>, <span class="st">"nodes"</span>, <span class="st">"prog."</span>, <span class="st">"estro."</span>, <span class="st">"grade"</span><span class="op">)</span></span>
<span><span class="va">feature_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">size_index</span>, <span class="va">nodes_index</span>,</span>
<span>                    <span class="va">pgr_index</span>, <span class="va">er_index</span>, <span class="va">grade_index</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># in this analysis, "full" predictions are obtained by regressing the conditional survival</span></span>
<span><span class="co"># function estimates given all features on the tumor-level features, i.e., leaving out</span></span>
<span><span class="co"># person features</span></span>
<span><span class="va">CV_full_preds</span> <span class="op">&lt;-</span> <span class="fu">CV_generate_reduced_predictions</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                                                    event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                                    X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                                                    landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                                                    folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                                                    sample_split <span class="op">=</span> <span class="va">sample_split</span>,</span>
<span>                                                    indx <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">person_index</span>, split <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span>,</span>
<span>                                                    full_preds_train <span class="op">=</span> <span class="va">CV_full_preds_train</span>,</span>
<span>                                                    SL.library <span class="op">=</span> <span class="va">SL.library</span><span class="op">)</span></span>
<span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_group_names</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indx_char</span> <span class="op">&lt;-</span> <span class="va">feature_groups</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">indx_name</span> <span class="op">&lt;-</span> <span class="va">feature_group_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">indx_char</span>, split <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">CV_reduced_preds</span> <span class="op">&lt;-</span> <span class="fu">CV_generate_reduced_predictions</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                                                   event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                                   X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                                                   landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                                                   folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                                                   sample_split <span class="op">=</span> <span class="va">sample_split</span>,</span>
<span>                                                   indx <span class="op">=</span> <span class="va">indx</span>,</span>
<span>                                                   full_preds_train <span class="op">=</span> <span class="va">CV_full_preds_train</span>,</span>
<span>                                                   SL.library <span class="op">=</span> <span class="va">SL.library</span><span class="op">)</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vim_AUC.html">vim_AUC</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                    event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                    approx_times <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>                    landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                    f_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CV_full_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    fs_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CV_reduced_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    S_hat <span class="op">=</span> <span class="va">CV_S_preds</span>,</span>
<span>                    G_hat <span class="op">=</span> <span class="va">CV_G_preds</span>,</span>
<span>                    folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                    ss_folds <span class="op">=</span> <span class="va">ss_folds</span>,</span>
<span>                    sample_split <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    scale_est <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">vim</span> <span class="op">&lt;-</span> <span class="st">"AUC"</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">indx_char</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indx_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">indx_name</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">pooled_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pooled_output</span>, <span class="va">output</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">pooled_output</span> <span class="op">&lt;-</span> <span class="va">output</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="va">p_auc</span> <span class="op">&lt;-</span> <span class="va">pooled_output</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>landmark_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">landmark_time</span>,</span>
<span>                                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">1500</span>, <span class="fl">2000</span><span class="op">)</span>,</span>
<span>                                labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"500 days"</span>, <span class="st">"1000 days"</span>, <span class="st">"1500 days"</span>, <span class="st">"2000 days"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">landmark_time</span>, <span class="va">est</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Order <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="op">{</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">est</span>, y <span class="op">=</span> <span class="va">Order</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_errorbarh.html" class="external-link">geom_errorbarh</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">cil</span>, xmax <span class="op">=</span> <span class="va">ciu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated importance"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Feature group"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.4</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>        breaks <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">Order</span>,</span>
<span>        labels <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">indx_name</span>,</span>
<span>      <span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">landmark_time</span>, dir <span class="op">=</span> <span class="st">"v"</span>, strip.position <span class="op">=</span> <span class="st">"right"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Adjusted subtractive AUC variable importance"</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            strip.placement <span class="op">=</span> <span class="st">"outside"</span><span class="op">)</span><span class="co">#,</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">p_auc</span></span></code></pre></div>
<p><img src="variable-importance_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="doubly-robust-estimation">Doubly-robust estimation<a class="anchor" aria-label="anchor" href="#doubly-robust-estimation"></a>
</h2>
<p>The VIM estimation procedure implemented in <code>survML</code> is
doubly-robust with respect to the conditional time-to-event survival
function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mn>0</mn></msub><annotation encoding="application/x-tex">S_0</annotation></semantics></math>
and conditional censoring survival function
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>G</mi><mn>0</mn></msub><annotation encoding="application/x-tex">G_0</annotation></semantics></math>:
Roughly speaking, as long as one of these two nuisance functions is
estimated well, the VIM estimator will tend in probability to the true
population VIM as the sample size increases.</p>
<p>In many cases, the oracle prediction functions
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mn>0</mn></msub><annotation encoding="application/x-tex">f_0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mi>s</mi></mrow></msub><annotation encoding="application/x-tex">f_{0,s}</annotation></semantics></math>
can themselves be estimated in a doubly-robust manner. For example, for
AUC and Brier score VIMs evaluated at landmark time
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mi>τ</mi><annotation encoding="application/x-tex">\tau</annotation></semantics></math>,
the oracle prediction function is simply
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo>∣</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S_0(\tau \mid x)</annotation></semantics></math>.
The pseudo-outcome approach of Rubin and van der Laan (2007) can be used
to construct a doubly-robust estimator of a conditional survival
function at a single time-point, at the computational cost of performing
an additional regression step. Given initial estimates of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>S</mi><mn>0</mn></msub><annotation encoding="application/x-tex">S_0</annotation></semantics></math>
and
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>G</mi><mn>0</mn></msub><annotation encoding="application/x-tex">G_0</annotation></semantics></math>,
the following code constructs a doubly-robust estimate of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>S</mi><mn>0</mn></msub><mrow><mo stretchy="true" form="prefix">(</mo><mi>τ</mi><mo>∣</mo><mi>x</mi><mo stretchy="true" form="postfix">)</mo></mrow></mrow><annotation encoding="application/x-tex">S_0(\tau \mid x)</annotation></semantics></math>
using Super Learner.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">generate_DR_predictions</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">time</span>,</span>
<span>                                    <span class="va">event</span>,</span>
<span>                                    <span class="va">X</span>,</span>
<span>                                    <span class="va">X_holdout</span>,</span>
<span>                                    <span class="va">landmark_times</span>,</span>
<span>                                    <span class="va">approx_times</span>,</span>
<span>                                    <span class="va">S_hat</span>,</span>
<span>                                    <span class="va">G_hat</span>,</span>
<span>                                    <span class="va">SL.library</span><span class="op">)</span><span class="op">{</span></span>
<span></span>
<span>  <span class="va">DR_predictions</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X_holdout</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">landmark_times</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">DR_predictions_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="cn">NA</span>, nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">X</span><span class="op">)</span>, ncol <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">landmark_times</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">landmark_times</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">tau</span> <span class="op">&lt;-</span> <span class="va">landmark_times</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>    <span class="va">Delta_t</span> <span class="op">&lt;-</span> <span class="va">event</span> <span class="op">*</span> <span class="op">(</span><span class="va">time</span> <span class="op">&lt;=</span> <span class="va">tau</span><span class="op">)</span> <span class="op">+</span> <span class="op">(</span><span class="va">time</span> <span class="op">&gt;</span> <span class="va">tau</span><span class="op">)</span></span>
<span>    <span class="va">Y_t</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html" class="external-link">pmin</a></span><span class="op">(</span><span class="va">time</span>, <span class="va">tau</span><span class="op">)</span></span>
<span></span>
<span>    <span class="co"># calculate m_0 at a specific time t</span></span>
<span>    <span class="va">calc_one</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">t</span><span class="op">)</span><span class="op">{</span></span>
<span>      <span class="kw">if</span> <span class="op">(</span><span class="va">approx_times</span><span class="op">[</span><span class="va">t</span><span class="op">]</span> <span class="op">&gt;=</span> <span class="va">tau</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">m</span> <span class="op">&lt;-</span>  <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">S_hat</span><span class="op">)</span><span class="op">)</span></span>
<span>      <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>        <span class="va">m</span> <span class="op">&lt;-</span> <span class="va">S_hat</span><span class="op">[</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">approx_times</span> <span class="op">==</span> <span class="va">tau</span><span class="op">)</span><span class="op">]</span><span class="op">/</span><span class="va">S_hat</span><span class="op">[</span>,<span class="va">t</span><span class="op">]</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="va">m</span><span class="op">)</span></span>
<span>    <span class="op">}</span></span>
<span>    <span class="co"># calculate m_0 over the whole grid</span></span>
<span>    <span class="va">ms</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unlist.html" class="external-link">unlist</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">approx_times</span><span class="op">)</span>, FUN <span class="op">=</span> <span class="va">calc_one</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                 nrow <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">m_Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Y_t</span><span class="op">)</span><span class="op">)</span>, MARGIN <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                 FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">ms</span><span class="op">[</span><span class="va">x</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">approx_times</span> <span class="op">-</span> <span class="va">Y_t</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">G_hat_Y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/apply.html" class="external-link">apply</a></span><span class="op">(</span>X <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/matrix.html" class="external-link">matrix</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">Y_t</span><span class="op">)</span><span class="op">)</span>, MARGIN <span class="op">=</span> <span class="fl">1</span>,</span>
<span>                     FUN <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="va">G_hat</span><span class="op">[</span><span class="va">x</span>,<span class="fu"><a href="https://rdrr.io/r/base/which.min.html" class="external-link">which.min</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/MathFun.html" class="external-link">abs</a></span><span class="op">(</span><span class="va">approx_times</span> <span class="op">-</span> <span class="va">Y_t</span><span class="op">[</span><span class="va">x</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">term1</span> <span class="op">&lt;-</span> <span class="va">Delta_t</span><span class="op">*</span><span class="op">(</span><span class="va">Y_t</span> <span class="op">&gt;=</span> <span class="va">tau</span><span class="op">)</span> <span class="op">/</span> <span class="va">G_hat_Y</span></span>
<span></span>
<span>    <span class="va">term2</span> <span class="op">&lt;-</span> <span class="op">(</span><span class="fl">1</span> <span class="op">-</span> <span class="va">Delta_t</span><span class="op">)</span> <span class="op">*</span> <span class="va">m_Y</span> <span class="op">/</span> <span class="va">G_hat_Y</span></span>
<span></span>
<span>    <span class="va">int.vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">sapply</a></span><span class="op">(</span><span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, <span class="kw">function</span><span class="op">(</span><span class="va">j</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">vals</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/diff.html" class="external-link">diff</a></span><span class="op">(</span><span class="fl">1</span><span class="op">/</span><span class="va">G_hat</span><span class="op">[</span><span class="va">j</span>,<span class="op">]</span><span class="op">)</span><span class="op">*</span> <span class="va">ms</span><span class="op">[</span><span class="va">j</span>,<span class="op">-</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">ncol</a></span><span class="op">(</span><span class="va">ms</span><span class="op">)</span><span class="op">]</span></span>
<span>      <span class="kw">if</span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/any.html" class="external-link">any</a></span><span class="op">(</span><span class="va">approx_times</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">Y_t</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>        <span class="va">vals</span><span class="op">[</span><span class="va">approx_times</span><span class="op">[</span><span class="op">-</span><span class="fl">1</span><span class="op">]</span> <span class="op">&gt;</span> <span class="va">Y_t</span><span class="op">[</span><span class="va">j</span><span class="op">]</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="fl">0</span></span>
<span>      <span class="op">}</span></span>
<span>      <span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="va">vals</span><span class="op">)</span></span>
<span>    <span class="op">}</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">term3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/t.html" class="external-link">t</a></span><span class="op">(</span><span class="va">int.vals</span><span class="op">)</span></span>
<span></span>
<span>    <span class="va">DR_pseudo_outcome</span> <span class="op">&lt;-</span> <span class="va">term1</span> <span class="op">+</span> <span class="va">term2</span> <span class="op">-</span> <span class="va">term3</span></span>
<span></span>
<span>    <span class="va">SL_fit</span> <span class="op">&lt;-</span> <span class="fu">SuperLearner</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/SuperLearner/man/SuperLearner.html" class="external-link">SuperLearner</a></span><span class="op">(</span>Y <span class="op">=</span> <span class="va">DR_pseudo_outcome</span>,</span>
<span>                                         X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                                         family <span class="op">=</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/family.html" class="external-link">gaussian</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>                                         SL.library <span class="op">=</span> <span class="va">SL.library</span>,</span>
<span>                                         method <span class="op">=</span> <span class="st">"method.NNLS"</span>,</span>
<span>                                         verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    <span class="va">SL_preds</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">SL_fit</span>, newdata <span class="op">=</span> <span class="va">X_holdout</span><span class="op">)</span><span class="op">$</span><span class="va">pred</span></span>
<span>    <span class="va">DR_predictions</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">SL_preds</span></span>
<span>    <span class="va">SL_preds_train</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html" class="external-link">predict</a></span><span class="op">(</span><span class="va">SL_fit</span>, newdata <span class="op">=</span> <span class="va">X</span><span class="op">)</span><span class="op">$</span><span class="va">pred</span></span>
<span>    <span class="va">DR_predictions_train</span><span class="op">[</span>,<span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">SL_preds_train</span></span>
<span></span>
<span>  <span class="op">}</span></span>
<span>  <span class="kw"><a href="https://rdrr.io/r/base/function.html" class="external-link">return</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>f_hat <span class="op">=</span> <span class="va">DR_predictions</span>, f_hat_train <span class="op">=</span> <span class="va">DR_predictions_train</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">}</span></span></code></pre></div>
<p>This doubly-robust estimator of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mn>0</mn></msub><annotation encoding="application/x-tex">f_0</annotation></semantics></math>
can then be regressed on the reduced covariate vector to give a
doubly-robust estimator of
<math display="inline" xmlns="http://www.w3.org/1998/Math/MathML"><semantics><msub><mi>f</mi><mrow><mn>0</mn><mo>,</mo><mi>s</mi></mrow></msub><annotation encoding="application/x-tex">f_{0,s}</annotation></semantics></math>.
These doubly-robust estimated oracle prediction functions can be used in
the usual manner to estimate variable importance. Here, we repeat the
original subtractive analysis using the doubly-robust pseudo-outcome
approach.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># reset feature groups</span></span>
<span><span class="va">age_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"age"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">meno_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"meno"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">size_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"size"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">nodes_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"nodes"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">pgr_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"pgr"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">er_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"er"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">hormon_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op">==</span> <span class="st">"hormon"</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">grade_index</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html" class="external-link">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/which.html" class="external-link">which</a></span><span class="op">(</span><span class="va">X_names</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"tumgrad2"</span>, <span class="st">"tumgrad3"</span><span class="op">)</span><span class="op">)</span>, collapse <span class="op">=</span> <span class="st">","</span><span class="op">)</span></span>
<span></span>
<span><span class="va">feature_group_names</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"age"</span>, <span class="st">"meno."</span>, <span class="st">"size"</span>, <span class="st">"nodes"</span>,</span>
<span>                         <span class="st">"prog."</span>, <span class="st">"estro."</span>, <span class="st">"hormone"</span>, </span>
<span>                         <span class="st">"grade"</span><span class="op">)</span></span>
<span><span class="va">feature_groups</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="va">age_index</span>, <span class="va">meno_index</span>, <span class="va">size_index</span>, <span class="va">nodes_index</span>,</span>
<span>                    <span class="va">pgr_index</span>, <span class="va">er_index</span>, <span class="va">hormon_index</span>, <span class="va">grade_index</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># generate nuisance estimates</span></span>
<span><span class="va">V0_preds</span> <span class="op">&lt;-</span> <span class="fu">CV_generate_full_predictions</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                                         event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                         X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                                         landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                                         approx_times <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>                                         folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                                         sample_split <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                                         SL.library <span class="op">=</span> <span class="va">SL.library</span>,</span>
<span>                                         DR_pred <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">CV_full_preds</span> <span class="op">&lt;-</span> <span class="va">V0_preds</span><span class="op">$</span><span class="va">CV_full_preds</span></span>
<span><span class="va">CV_full_preds_train</span> <span class="op">&lt;-</span> <span class="va">V0_preds</span><span class="op">$</span><span class="va">CV_full_preds_train</span></span>
<span><span class="va">CV_S_preds</span> <span class="op">&lt;-</span> <span class="va">V0_preds</span><span class="op">$</span><span class="va">CV_S_preds</span></span>
<span><span class="va">CV_S_preds_train</span> <span class="op">&lt;-</span> <span class="va">V0_preds</span><span class="op">$</span><span class="va">CV_S_preds_train</span></span>
<span><span class="va">CV_G_preds</span> <span class="op">&lt;-</span> <span class="va">V0_preds</span><span class="op">$</span><span class="va">CV_G_preds</span></span>
<span></span>
<span><span class="co"># iterate over feature groups</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">feature_group_names</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>  <span class="va">indx_char</span> <span class="op">&lt;-</span> <span class="va">feature_groups</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">indx_name</span> <span class="op">&lt;-</span> <span class="va">feature_group_names</span><span class="op">[</span><span class="va">i</span><span class="op">]</span></span>
<span>  <span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/strsplit.html" class="external-link">strsplit</a></span><span class="op">(</span><span class="va">indx_char</span>, split <span class="op">=</span> <span class="st">","</span><span class="op">)</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co"># estimate residual oracle prediction function for this feature group</span></span>
<span>  <span class="va">CV_reduced_preds</span> <span class="op">&lt;-</span> <span class="fu">CV_generate_reduced_predictions</span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                                              event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                                              X <span class="op">=</span> <span class="va">X</span>,</span>
<span>                                              landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                                              folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                                              sample_split <span class="op">=</span> <span class="va">sample_split</span>,</span>
<span>                                              indx <span class="op">=</span> <span class="va">indx</span>,</span>
<span>                                              full_preds_train <span class="op">=</span> <span class="va">CV_full_preds_train</span>,</span>
<span>                                              SL.library <span class="op">=</span> <span class="va">SL.library</span><span class="op">)</span></span>
<span>  <span class="co"># estimate VIM - note the oracle for AUC is the conditional cdf, not survival function, </span></span>
<span>  <span class="co"># so need to take 1 - S(tau | x)</span></span>
<span>  <span class="va">output</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/vim_AUC.html">vim_AUC</a></span><span class="op">(</span>time <span class="op">=</span> <span class="va">time</span>,</span>
<span>                    event <span class="op">=</span> <span class="va">event</span>,</span>
<span>                    approx_times <span class="op">=</span> <span class="va">approx_times</span>,</span>
<span>                    landmark_times <span class="op">=</span> <span class="va">landmark_times</span>,</span>
<span>                    f_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CV_full_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    fs_hat <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/lapply.html" class="external-link">lapply</a></span><span class="op">(</span><span class="va">CV_reduced_preds</span>, <span class="kw">function</span><span class="op">(</span><span class="va">x</span><span class="op">)</span> <span class="fl">1</span><span class="op">-</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    S_hat <span class="op">=</span> <span class="va">CV_S_preds</span>,</span>
<span>                    G_hat <span class="op">=</span> <span class="va">CV_G_preds</span>,</span>
<span>                    folds <span class="op">=</span> <span class="va">folds</span>,</span>
<span>                    ss_folds <span class="op">=</span> <span class="va">ss_folds</span>,</span>
<span>                    sample_split <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>                    scale_est <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">vim</span> <span class="op">&lt;-</span> <span class="st">"AUC"</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indx</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">indx_char</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="va">output</span><span class="op">$</span><span class="va">indx_name</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="va">indx_name</span>, <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">output</span><span class="op">)</span><span class="op">)</span></span>
<span>  <span class="kw">if</span> <span class="op">(</span><span class="op">!</span><span class="op">(</span><span class="va">i</span> <span class="op">==</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">{</span></span>
<span>    <span class="va">pooled_output</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">pooled_output</span>, <span class="va">output</span><span class="op">)</span></span>
<span>  <span class="op">}</span> <span class="kw">else</span><span class="op">{</span></span>
<span>    <span class="va">pooled_output</span> <span class="op">&lt;-</span> <span class="va">output</span></span>
<span>  <span class="op">}</span></span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co"># plot results</span></span>
<span><span class="va">p_auc</span> <span class="op">&lt;-</span> <span class="va">pooled_output</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>   <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>landmark_time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/factor.html" class="external-link">factor</a></span><span class="op">(</span><span class="va">landmark_time</span>,</span>
<span>                                levels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">500</span>, <span class="fl">1000</span>, <span class="fl">1500</span>, <span class="fl">2000</span><span class="op">)</span>,</span>
<span>                                labels <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"500 days"</span>, <span class="st">"1000 days"</span>, <span class="st">"1500 days"</span>, <span class="st">"2000 days"</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html" class="external-link">arrange</a></span><span class="op">(</span><span class="va">landmark_time</span>, <span class="va">est</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html" class="external-link">mutate</a></span><span class="op">(</span>Order <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/row_number.html" class="external-link">row_number</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html" class="external-link">%&gt;%</a></span></span>
<span>  <span class="op">{</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html" class="external-link">ggplot</a></span><span class="op">(</span><span class="va">.</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">est</span>, y <span class="op">=</span> <span class="va">Order</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_errorbarh.html" class="external-link">geom_errorbarh</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html" class="external-link">aes</a></span><span class="op">(</span>xmin <span class="op">=</span> <span class="va">cil</span>, xmax <span class="op">=</span> <span class="va">ciu</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html" class="external-link">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html" class="external-link">theme_bw</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">xlab</a></span><span class="op">(</span><span class="st">"Estimated importance"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ylab</a></span><span class="op">(</span><span class="st">"Feature group"</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/lims.html" class="external-link">xlim</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>,<span class="fl">0.3</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_continuous.html" class="external-link">scale_y_continuous</a></span><span class="op">(</span></span>
<span>        breaks <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">Order</span>,</span>
<span>        labels <span class="op">=</span> <span class="va">.</span><span class="op">$</span><span class="va">indx_name</span>,</span>
<span>      <span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_wrap.html" class="external-link">facet_wrap</a></span><span class="op">(</span><span class="op">~</span><span class="va">landmark_time</span>, dir <span class="op">=</span> <span class="st">"v"</span>, strip.position <span class="op">=</span> <span class="st">"right"</span>, scales <span class="op">=</span> <span class="st">"free_y"</span>, ncol <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op">+</span> </span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Subtractive AUC variable importance (doubly-robust pseudo-outcome)"</span><span class="op">)</span><span class="op">+</span></span>
<span>      <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html" class="external-link">theme</a></span><span class="op">(</span>strip.background <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html" class="external-link">element_blank</a></span><span class="op">(</span><span class="op">)</span>,</span>
<span>            strip.placement <span class="op">=</span> <span class="st">"outside"</span><span class="op">)</span></span>
<span>  <span class="op">}</span></span>
<span><span class="va">p_auc</span></span></code></pre></div>
<p><img src="variable-importance_files/figure-html/unnamed-chunk-8-1.png" width="768"></p>
</div>
<div class="section level2">
<h2 id="appendix">Appendix<a class="anchor" aria-label="anchor" href="#appendix"></a>
</h2>
<p>Some example predictiveness measures, along with the corresponding
oracle prediction functions, are given below.</p>
<ul>
<li><p>AUC: <span class="math display">$$ V(f, P_0) = P_0\{f(X_1) &gt;
f(X_2) \mid T_1 \leq \tau, T_2 &gt; \tau\} \hspace{0.5in} f_0(x) = 1 -
S_0(\tau \mid x).$$</span></p></li>
<li><p>Brier score: <span class="math display">$$
V(f, P_0) = E_{P_0}[\{f(X) - I(T &gt; \tau)\}^2] \hspace{0.5in} f_0(x) =
S_0(\tau \mid x).
$$</span></p></li>
<li><p>Survival time MSE: <span class="math display">$$
V(f, P_0) = E_{P_0}[\{f(X) - (T \wedge \tau)\}^2] \hspace{0.5in} f_0(x)
= \int_0^\tau S_0(t \mid x)dt.
$$</span></p></li>
<li><p>Proportion of explained variance: <span class="math display">$$
V(f, P_0) = \frac{E_{P_0}[\{f(X) - I(T &gt; \tau)\}^2]}{var[I(T &gt;
\tau)]} \hspace{0.5in} f_0(x) = S_0(\tau \mid x).
$$</span></p></li>
<li><p>Binary classification accuracy: <span class="math display">$$
V(f, P_0) = P_0\{f(X) = I(T &gt; \tau)\} \hspace{0.5in} f_0(x) =
I\{S_0(\tau \mid x) &gt; 0.5\}.
$$</span></p></li>
<li><p>C-index: <span class="math display">$$
V(f, P_0) = P_0\{f(X_1) &gt; f(X_2) \mid T_1 \leq T_2\} \hspace{0.5in}
f_0(x) \hspace{0.1in} \text{[no closed form]}.
$$</span> For the C-index, there is, to our knowledge, no closed form of
the oracle prediction function; see the preprint for more details on our
proposed procedure for direct numerical optimization.</p></li>
</ul>
</div>
<div class="section level2">
<h2 id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<p>The survival variable importance methodology is described in</p>
<p>Charles J. Wolock, Peter B. Gilbert, Noah Simon and Marco Carone.
“Assessing variable importance in survival analysis using machine
learning.” <a href="https://arxiv.org/abs/2311.12726" class="external-link">arXiv:2311.12726</a>.</p>
<p>Other references:</p>
<p>David R. Cox. <a href="https://doi.org/10.1111/j.2517-6161.1972.tb00899.x" class="external-link">“Regression
Models and Life-Tables.”</a> <em>Journal of the Royal Statistical
Society: Series B (Methodological)</em> (1972).</p>
<p>Ted Westling, Alex Luedtke, Peter B. Gilbert and Marco Carone. <a href="https://doi.org/10.1080/01621459.2023.2205060" class="external-link">“Inference for
treatment-specific survival curves using machine learning.”</a>
<em>Journal of the American Statistical Association</em> (2023).</p>
<p>Charles J. Wolock, Peter B. Gilbert, Noah Simon and Marco Carone. <a href="https://doi.org/10.1080/10618600.2024.2304070" class="external-link">“A framework for
leveraging machine learning tools to estimate personalized survival
curves.”</a> <em>Journal of Computational and Graphical Statistics</em>
(2024).</p>
<p>Mark J. van der Laan, Eric C. Polley and Alan E. Hubbard. <a href="https://doi.org/10.2202/1544-6115.1309" class="external-link">“Super learner”</a>.
<em>Statistical Applications in Genetics and Molecular Biology</em>
(2007).</p>
<p>Daniel Rubin and Mark J. van der Laan. <a href="https://doi.org/10.2202/1557-4679.1052" class="external-link">“A doubly robust censoring
unbiased transformation”</a>. <em>International Journal of
Biostatistics</em> (2007).</p>
</div>
  </main><aside class="col-md-3"><nav id="toc" aria-label="Table of contents"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Charles Wolock.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.1.0.</p>
</div>

    </footer>
</div>





  </body>
</html>
